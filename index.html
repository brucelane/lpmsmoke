<!DOCTYPE html>
<html>

<head>
    <title>smoke</title>
    <script type="text/javascript" src="lib/three.min.js"></script>
    <script type="text/javascript" src="lib/jquery-1.9.0.js"></script>

    <style>
        body {
            /* set margin to 0 and overflow to hidden, to go fullscreen */
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>

<!-- Div which will hold the Output -->
<div id="WebGL-output">
</div>

<script type="text/javascript">

    // once everything is loaded, we run our Three.js stuff.
    $(function () {

        // create a scene, that will hold all our elements such as objects, cameras and lights.
        var scene = new THREE.Scene();

        // create a camera, which defines where we're looking at.
        var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);

        // create a render and set the size
        var webGLRenderer = new THREE.WebGLRenderer();
        webGLRenderer.setClearColorHex(0x000, 1.0);
        webGLRenderer.setSize(window.innerWidth, window.innerHeight);
        webGLRenderer.shadowMapEnabled = true;

        // position and point the camera to the center of the scene
        camera.position.x = 20;
        camera.position.y = 0;
        camera.position.z = 150;

        camera.lookAt(new THREE.Vector3(0, 0, 0));

        var clock = new THREE.Clock();

        //var ambi = new THREE.AmbientLight(0x181818);
        var ambi = new THREE.AmbientLight(0xf8f8f8);
        scene.add(ambi);

        var spotLight = new THREE.DirectionalLight(0xffffff);
        spotLight.position.set(550, 100, 550);
        spotLight.intensity = 0.6;

        scene.add(spotLight);

        // add the output of the renderer to the html element
        $("#WebGL-output").append(webGLRenderer.domElement);

        // lpm logo
        var lpmTexture = THREE.ImageUtils.loadTexture("assets/lpm.png")

        var lpmMaterial = new THREE.MeshPhongMaterial();
        lpmMaterial.map = lpmTexture;

        var lpmPlane = new THREE.Mesh(
            new THREE.PlaneGeometry(80,40,1,1),
            lpmMaterial
        );
        
        lpmPlane.position.x = 0;
        lpmPlane.position.y = -40; 
        lpmPlane.position.z = 2;
        scene.add( lpmPlane ); 
        //particles
        var smokeParticles = new THREE.Geometry;
        for (var i = 0; i < 20000; i++) {
            var particle = new THREE.Vector3(Math.random() * 64 - 32, Math.random() * 230, Math.random() * 4 );
            smokeParticles.vertices.push(particle);
        }
        var smokeTexture = THREE.ImageUtils.loadTexture('assets/smoke.png');
        var smokeMaterial = new THREE.ParticleBasicMaterial({ map: smokeTexture, opacity: 0.3, transparent: true, blending: THREE.AdditiveBlending, size: 7, color: 0xffffff });

        var smoke = new THREE.ParticleSystem(smokeParticles, smokeMaterial);
        smoke.sortParticles = true;

        smoke.position.x = 8;
        smoke.position.y = -30;
        smoke.position.z = 15;
        scene.add(smoke);

        // call the render function
        render();

        function render() {

            var delta = clock.getDelta();
            //console.log("delta:" + delta);
            var particleCount = smokeParticles.vertices.length;
            while (particleCount--) {
                var particle = smokeParticles.vertices[particleCount];
                particle.x += ( Math.random() - 0.5 )  * 0.08 * particle.y;
                particle.y += delta * 3;
                 
                if (particle.y >= 230) {
            //console.log("delta:" + delta);
                    particle.y = Math.random() * 16;
                    particle.x = Math.random() * 64 - 32;
                    //particle.z = Math.random() * 64 - 16;
                }
            }
            smokeParticles.__dirtyVertices = true;

            webGLRenderer.render(scene, camera);
            // render using requestAnimationFrame
            requestAnimationFrame(render);

        }

    });


</script>
</body>
</html>